<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MC PREDICT - MATCH WINNER HISTORICAL PREDICTIONS</title>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Fonts + Global styles -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Proxima+Nova:wght@400;700&display=swap">
  <link rel="stylesheet" href="style.css">
</head>

<body class="home">
  <!-- Loading overlay for historical data -->
  <div class="loading-overlay" id="loadingOverlay" aria-live="polite">
    <div class="loading-ball">‚öΩ</div>
    <div class="loading-pitch-line"></div>
    <div class="loading-title">Loading Historical Matches</div>
    <p class="loading-subtitle">
      We&#39;re pulling in every historical prediction, price and result from the database.
    </p>
    <div class="loading-ticker">Fetching data...</div>
  </div>

  <div class="home-page">

    <!-- Top bar -->
    <header class="home-topbar">
      <div class="topbar-inner">
        <div class="topbar-left">
          <div class="topbar-logo">
            <img src="images/mcpredcirclebg.png" alt="MC Predict Logo" />
          </div>
          <div class="topbar-title">
            <h1>MC PREDICT</h1>
            <span>Data-driven Football predictions</span>
          </div>
        </div>
        <div class="topbar-tag">
          <span class="topbar-tag-dot"></span>
          <span>Historical</span>
        </div>
      </div>

      <!-- Desktop / tablet nav -->
      <nav class="primary-nav" aria-label="Primary navigation">
        <a href="/index">Home</a>
        <a href="/hda-value">Match Result</a>
        <a href="/uo-value">Under/Over 2.5</a>
        <a href="/lucky-dip">Lucky Dip</a>
        <a href="/historical" class="active">Historical Data</a>
        <a href="/faqs">FAQs</a>
      </nav>

      <!-- Sub-nav for fractional / decimal -->
      <div class="sub-nav-pills" aria-label="Odds format views">
        <a href="/hda-histf" class="active">Fractional Odds</a>
        <a href="/hda-histd">Decimal Odds</a>
      </div>
    </header>

    <!-- Main content layout -->
    <section class="data-layout">
      <div class="data-main-card">
        <div class="data-eyebrow">Match Result</div>
        <h2 class="data-title">Historical predictions ‚Äì fractional odds</h2>
        <p class="data-subtitle">
          Explore every historical match result prediction, including prices, value rating and outcome.
        </p>

        <!-- SUMMARY PANEL -->
        <div class="summary-strip" aria-label="Summary of filtered bets">
          <div class="summary-card">
            <div class="summary-label">Bets</div>
            <div class="summary-value" id="summary-bets">0</div>
            <div class="summary-subtext">Rows shown</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Correct</div>
            <div class="summary-value" id="summary-correct">0</div>
            <div class="summary-subtext">Winning bets</div>
          </div>
          <div class="summary-card summary-card--pl">
            <div class="summary-label">Profit / Loss</div>
            <div class="summary-value" id="summary-pl">¬£0.00</div>
            <div class="summary-subtext">On filtered bets</div>
          </div>
        </div>

        <p class="note-text">
          NOTE: The returns are calculated on decimal odds and may not perfectly align to the fractional
          odds represented below. You can view the actual decimal odds using the options above.
        </p>

        <!-- Date range filters -->
        <div class="filter-title">Date range</div>
        <div class="date-filters">
          <label for="start-date">
            From
            <input type="date" id="start-date" />
          </label>
          <label for="end-date">
            To
            <input type="date" id="end-date" />
          </label>
          <button type="button" id="clear-date-filters">Clear dates</button>
        </div>

        <!-- Filter controls -->
        <div class="filter-title">Filter options</div>
        <div class="filters" id="prediction-filters">
          <button data-pred="HOME WIN">Home Win</button>
          <button data-pred="AWAY WIN">Away Win</button>
        </div>
        <div class="filters" id="value-filters">
          <button data-val="‚ùå">‚ùå</button>
          <button data-val="‚ùå‚ùå">‚ùå‚ùå</button>
          <button data-val="‚ùå‚ùå‚ùå">‚ùå‚ùå‚ùå</button>
          <button data-val="üí∞">üí∞</button>
          <button data-val="üí∞üí∞">üí∞üí∞</button>
          <button data-val="üí∞üí∞üí∞">üí∞üí∞üí∞</button>
        </div>

        <!-- DataTable -->
        <div class="table-container data-table">
          <table id="predictionsTable" class="display">
            <thead>
              <tr>
                <th>Date</th>
                <th>League</th>
                <th>Home</th>
                <th>V</th>
                <th>Away</th>
                <th>Prediction</th>
                <th>Bookmaker Price</th>
                <th>Model Price</th>
                <th>Value</th>
                <th>Result</th>
                <th>P/L</th>
                <th>Correct?</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="home-footer">
      MC Predict is for informational purposes only and does not guarantee outcomes. Please bet responsibly.
    </footer>
  </div>

  <!-- Bottom mobile nav -->
  <nav class="bottom-nav" aria-label="Primary navigation">
    <a href="/index" data-key="home">
      <span class="icon">üè†</span>
      <span class="label">Home</span>
    </a>
    <a href="/hda-value" data-key="hda">
      <span class="icon">üèÜ</span>
      <span class="label">Result</span>
    </a>
    <a href="/uo-value" data-key="uo">
      <span class="icon">‚öΩ</span>
      <span class="label">U/O 2.5</span>
    </a>
    <a href="/lucky-dip" data-key="lucky">
      <span class="icon">üé≤</span>
      <span class="label">Lucky</span>
    </a>
    <a href="/historical" class="active" data-key="historical">
      <span class="icon">üìä</span>
      <span class="label">History</span>
    </a>
    <a href="/faqs" data-key="faqs">
      <span class="icon">‚ùì</span>
      <span class="label">FAQs</span>
    </a>
  </nav>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRoeausAAqFFCFoB0NK4vjsgmmzxP_J-WtgvUdusuau-jmJ3d3fqPAAa_ujd7nGYag5rJFOysZZUYiA/pub?gid=0&single=true&output=csv";

    // Column index mapping into the CSV
    const IDX = { H:7, L:11, M:12, N:13, O:14, P:15, S:18, V:21, X:23, AA:26, AC:28, AD:29 };

    // In the DataTable, the visible columns are in this order:
    // 0: Date, 1: League, 2: Home, 3: V, 4: Away, 5: Prediction,
    // 6: Bookmaker, 7: Model, 8: Value, 9: Result, 10: P/L, 11: Correct?
    const DT_COL_PREDICTION = 5; // maps to CSV column P
    const DT_COL_VALUE = 8;      // maps to CSV column X (‚ùå/üí∞ sequences)

    // Filter state (multi-select). Empty = no restriction for that group.
    const selectedPredictions = new Set();
    const selectedValues = new Set();

    // Date range filter state
    let minDate = null;
    let maxDate = null;

    function ddmmyyyyToISO(str){
      if (!str) return "";
      const parts = str.split("/");
      if (parts.length !== 3) return "";
      let [d, m, y] = parts;
      if (y.length === 2) y = "20" + y;
      return `${y.padStart(4,"0")}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }

    function parseCurrencyToNumber(text){
      if (!text) return 0;
      const s = String(text).trim();
      const sign = s.includes("-") ? -1 : 1;
      const num = parseFloat(s.replace(/[^0-9.]/g, ""));
      return (isNaN(num) ? 0 : num) * sign;
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById("loadingOverlay");
      if (!overlay) return;
      overlay.classList.add("hidden");
      setTimeout(() => {
        overlay.style.display = "none";
      }, 450);
    }

    function formatPL(value){
      const signChar = value > 0 ? "+" : "";
      return signChar + "¬£" + value.toFixed(2);
    }

    $(document).ready(function(){
      Papa.parse(CSV_URL, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(res){
          const rows = (res.data || []).filter(r => Array.isArray(r) && r.length > 0);
          const data = [];

          for (let i = 1; i < rows.length; i++){
            const r = rows[i];
            const dateDisp = r[IDX.H] || "";
            const dateSort = ddmmyyyyToISO(dateDisp);

            const plDisp = r[IDX.AC] || "";
            const plSort = parseCurrencyToNumber(plDisp);

            const correct =
              r[IDX.AD] === "1" ? '<i class="fa-solid fa-circle-check" title="Correct"></i>' :
              r[IDX.AD] === "0" ? '<i class="fa-solid fa-circle-xmark" title="Incorrect"></i>' : "";

            data.push([
              { display: dateDisp, sort: dateSort }, // 0 Date
              r[IDX.L] || "",                         // 1 League
              r[IDX.M] || "",                         // 2 Home
              r[IDX.N] || "",                         // 3 V
              r[IDX.O] || "",                         // 4 Away
              r[IDX.P] || "",                         // 5 Prediction (HOME WIN / AWAY WIN)
              r[IDX.S] || "",                         // 6 Bookmaker Price
              r[IDX.V] || "",                         // 7 Model Price
              r[IDX.X] || "",                         // 8 Value (‚ùå / üí∞)
              r[IDX.AA] || "",                        // 9 Result
              { display: plDisp, sort: plSort },      // 10 P/L
              correct                                 // 11 Correct?
            ]);
          }

          const table = $('#predictionsTable').DataTable({
            data,
            pageLength: 100,
            lengthMenu: [10, 25, 50, 100, 250, 500],
            order: [[0, 'desc']],
            autoWidth: false,
            deferRender: true,
            columns: [
              { title: 'Date', render: { _: 'display', sort: 'sort' } },
              { title: 'League' },
              { title: 'Home' },
              { title: 'V' },
              { title: 'Away' },
              { title: 'Prediction' },
              { title: 'Bookmaker Price' },
              { title: 'Model Price' },
              { title: 'Value' },
              { title: 'Result' },
              { title: 'P/L', render: { _: 'display', sort: 'sort' } },
              { title: 'Correct?' }
            ]
          });

          // --- Custom filtering: OR within group, AND across groups + date range ---
          $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
            if (settings.nTable !== document.getElementById('predictionsTable')) {
              return true; // only apply to this table
            }

            const api = new $.fn.dataTable.Api(settings);
            const rowData = api.row(dataIndex).data() || [];

            // Date filter
            let datePass = true;
            const dateObj = rowData[0] || {};
            const dateSortStr = dateObj.sort || null;

            if (dateSortStr && (minDate || maxDate)) {
              const rowDate = new Date(dateSortStr);
              if (minDate && rowDate < minDate) datePass = false;
              if (maxDate && rowDate > maxDate) datePass = false;
            }

            // Group 1: Prediction (OR). Empty selection => pass.
            const predVal = (data[DT_COL_PREDICTION] || "").toUpperCase().trim(); // "HOME WIN" / "AWAY WIN" / ""
            const valueVal = (data[DT_COL_VALUE] || "").trim();                   // "‚ùå", "üí∞üí∞", etc.

            const predPass = (selectedPredictions.size === 0) || selectedPredictions.has(predVal);
            const valuePass = (selectedValues.size === 0) || selectedValues.has(valueVal);

            return predPass && valuePass && datePass;
          });

          // Wire up prediction filter buttons
          function hookPredictionFilters(){
            $('#prediction-filters button').on('click', function(){
              const v = ($(this).data('pred') || "").toString().toUpperCase().trim();
              if (selectedPredictions.has(v)) {
                selectedPredictions.delete(v);
                $(this).removeClass('active');
              } else {
                selectedPredictions.add(v);
                $(this).addClass('active');
              }
              table.draw();
            });
          }

          // Wire up value filter buttons
          function hookValueFilters(){
            $('#value-filters button').on('click', function(){
              const v = ($(this).data('val') || "").toString().trim();
              if (selectedValues.has(v)) {
                selectedValues.delete(v);
                $(this).removeClass('active');
              } else {
                selectedValues.add(v);
                $(this).addClass('active');
              }
              table.draw();
            });
          }

          hookPredictionFilters();
          hookValueFilters();

          // Date range events
          $('#start-date').on('change', function() {
            minDate = this.value ? new Date(this.value) : null;
            table.draw();
          });

          $('#end-date').on('change', function() {
            maxDate = this.value ? new Date(this.value) : null;
            table.draw();
          });

          $('#clear-date-filters').on('click', function() {
            $('#start-date').val('');
            $('#end-date').val('');
            minDate = null;
            maxDate = null;
            table.draw();
          });

          // --- Summary update ---
          function updateSummary() {
            const api = table;
            const rows = api.rows({ filter: 'applied' }).data();
            const totalBets = rows.length;

            let correctBets = 0;
            let totalPL = 0;

            for (let i = 0; i < rows.length; i++) {
              const row = rows[i];

              // Correct? column (HTML with FA icon)
              const correctHtml = row[11] || "";
              if (typeof correctHtml === "string" && correctHtml.indexOf("fa-circle-check") !== -1) {
                correctBets++;
              }

              // P/L column
              const plCol = row[10];
              let plVal = 0;
              if (plCol && typeof plCol.sort !== "undefined") {
                plVal = plCol.sort;
              } else if (plCol != null) {
                plVal = parseCurrencyToNumber(plCol);
              }
              totalPL += plVal;
            }

            $('#summary-bets').text(totalBets);
            $('#summary-correct').text(correctBets);

            // Update PL display + colour
            const plDisplay = formatPL(totalPL);
            const plEl = $('#summary-pl');
            plEl.text(plDisplay);

            const plCard = $('.summary-card--pl');
            if (totalPL < 0) {
              plCard.css('color', '#ff6b6b');
              plEl.css('color', '#ff6b6b');
            } else {
              plCard.css('color', '');
              plEl.css('color', '#40c456');
            }
          }

          // Initial summary + hook to table draw
          updateSummary();
          table.on('draw', function() {
            updateSummary();
          });

          // Hide loading overlay once data/table is ready
          hideLoadingOverlay();
        },
        error: function(err){
          console.error("Error loading CSV:", err);
          hideLoadingOverlay();
        }
      });
    });
  </script>
</body>
</html>
